<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>마이워치</title>

<!-- 기본 메타 -->
<meta name="theme-color" content="#2b74ff"/>

<!-- 아이콘(내장된 Base64 이미지 사용) -->
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAABWGlDQ1BJQ0MgUHJvZmlsZQAAeJx9kLFLw1AQxr9WpaB1EB0cHDKJQ5SSCro4tBVEcQhVweqU..." />

<!-- 스타일 (현대적, 아이폰 스타일 A 테마) -->
<style>
:root{
  --bg:#fbfbfd; --card:#fff; --text:#111; --muted:#6b7280; --accent:#2b74ff; --radius:12px; --border:#e6e9ef;
}
@media(prefers-color-scheme:dark){
  :root{ --bg:#07070a; --card:#0f0f12; --text:#e6eef8; --muted:#9aa4b2; --accent:#4b8dff; --border:#1a1a1a; }
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;background:var(--bg);color:var(--text);}
.app-header{background:linear-gradient(90deg,var(--accent),#6aa2ff);padding:14px 16px;color:#fff;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:40;backdrop-filter:blur(6px)}
.app-header h1{font-size:18px;margin:0}
.container{padding:12px 14px 80px}

/* 탭 */
.tabs{display:flex;gap:8px;margin-top:12px}
.tabs button{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;cursor:pointer;font-weight:600}
.tabs button.active{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0)); box-shadow:0 2px 10px rgba(43,116,255,0.12); color:var(--accent)}

/* top controls */
.top-controls{display:flex;gap:8px;align-items:center;margin-top:12px}
.search-box{flex:1;display:flex;gap:8px;align-items:center}
.search-box input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card)}
.select, .btn {padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border:0}

/* content */
.brand-list{margin-top:14px;display:flex;flex-direction:column;gap:12px}

/* brand card */
.brand-card{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid var(--border);box-shadow:0 6px 18px rgba(3,10,30,0.04)}
.brand-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand-top .left{display:flex;gap:12px;align-items:center}
.brand-top h3{margin:0;font-size:16px}
.brand-actions{display:flex;gap:8px}

/* watch item */
.watch-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.watch-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);cursor:pointer;position:relative}
.watch-item img{width:72px;height:72px;border-radius:8px;object-fit:cover}
.watch-meta{display:flex;flex-direction:column}
.watch-meta b{font-size:15px}
.watch-meta .muted{color:var(--muted);font-size:13px}

/* drag handle (for user order) */
.drag-handle{width:34px;height:18px;border-radius:10px;display:inline-block;background:repeating-linear-gradient(180deg,var(--muted),var(--muted) 2px,transparent 2px,transparent 4px);margin-left:auto;cursor:grab}
.controls-small{display:flex;gap:8px;align-items:center}

/* floating add */
.fab{position:fixed;right:18px;bottom:18px;padding:14px 16px;border-radius:999px;background:var(--accent);color:#fff;border:0;font-weight:700;box-shadow:0 10px 30px rgba(43,116,255,0.18);cursor:pointer;z-index:80}

/* modal */
.modal {position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:100}
.modal .dialog{width:95%;max-width:520px;background:var(--card);padding:18px;border-radius:14px;border:1px solid var(--border);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.form-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.form-row input, .form-row select, textarea{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg)}
textarea{min-height:80px;resize:vertical;padding-top:10px}
.preview-img img{max-width:100%;border-radius:10px;margin-top:8px}

/* responsive: landscape -> grid for watches */
@media (orientation: landscape) {
  .watch-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .watch-item{flex-direction:column;align-items:flex-start}
  .watch-item img{width:100%;height:140px;border-radius:10px}
  .drag-handle{position:absolute;right:12px;top:12px}
}

/* small screens */
@media (max-width:420px){
  .app-header h1{font-size:16px}
}
</style>
</head>

<body>
<header class="app-header">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" style="flex:0 0 28px"><circle cx="12" cy="12" r="9" stroke="white" stroke-width="1.2"/><path d="M12 7v5l3 2" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
  <h1>마이워치</h1>
</header>

<div class="container">
  <!-- 탭 -->
  <div class="tabs" role="tablist">
    <button class="active" data-cat="owned">보유</button>
    <button data-cat="wishlist">위시리스트</button>
    <button data-cat="scrap">스크랩</button>
  </div>

  <!-- controls -->
  <div class="top-controls">
    <div class="search-box">
      <input id="searchInput" placeholder="검색 — 모델명, 브랜드, 메모 등" />
      <select id="sortSelect" class="select">
        <option value="createdRecent">등록일 최신순</option>
        <option value="createdOld">등록일 오래된 순</option>
        <option value="priceHigh">가격 높은 순</option>
        <option value="priceLow">가격 낮은 순</option>
        <option value="dateRecent">구매일 최신순</option>
        <option value="dateOld">구매일 오래된 순</option>
        <option value="custom">사용자 정렬</option>
      </select>
    </div>

    <div class="controls-small">
      <button id="editOrderBtn" class="btn" title="사용자 정렬 보이기">정렬 수정</button>
      <button id="deleteBrandBtn" class="btn" title="선택된 브랜드 삭제">브랜드 삭제</button>
    </div>
  </div>

  <!-- 브랜드 목록 -->
  <div id="brandList" class="brand-list" aria-live="polite"></div>

  <!-- 추가 버튼 -->
  <button id="addBrandFab" class="fab">브랜드 추가</button>
</div>

<!-- 브랜드 모달 -->
<div id="brandModal" class="modal" style="display:none">
  <div class="dialog">
    <h3 id="brandModalTitle">브랜드 추가</h3>
    <div class="form-row"><input id="brandName" placeholder="브랜드명 입력" /></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="brandCancelBtn" class="btn">취소</button>
      <button id="brandSaveBtn" class="btn primary">저장</button>
    </div>
  </div>
</div>

<!-- 시계 모달 -->
<div id="watchModal" class="modal" style="display:none">
  <div class="dialog">
    <h3 id="watchModalTitle">시계 추가</h3>

    <label class="form-row file-input" style="align-items:center;cursor:pointer">
      <input id="watchImage" type="file" accept="image/*" />
      <span>이미지 선택</span>
    </label>
    <div id="watchPreview" class="preview-img"></div>

    <div class="form-row"><input id="watchModel" placeholder="모델명 (필수)"/></div>
    <div class="form-row"><input id="watchPrice" type="number" placeholder="가격"/></div>
    <div class="form-row"><input id="watchFunction" placeholder="기능"/></div>
    <div class="form-row"><input id="watchFeature" placeholder="특징"/></div>
    <div class="form-row"><input id="watchBuyDate" type="date"/></div>
    <div class="form-row"><input id="watchBuyPrice" type="number" placeholder="구매가격"/></div>
    <div class="form-row"><textarea id="watchMemo" placeholder="메모"></textarea></div>

    <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px;align-items:center">
      <div>
        <label style="font-size:13px;color:var(--muted)">이 브랜드로 저장: </label>
        <select id="watchBrandSelect" style="padding:8px;border-radius:8px;border:1px solid var(--border)"></select>
      </div>
      <div style="display:flex;gap:8px">
        <button id="watchCancelBtn" class="btn">취소</button>
        <button id="watchSaveBtn" class="btn primary">저장</button>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;justify-content:space-between;gap:8px">
      <div style="flex:1">
        <label class="muted" style="font-size:13px">다른 브랜드로 이동</label>
        <select id="moveToBrand" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></select>
        <button id="moveBtn" style="margin-top:8px" class="btn">이동</button>
      </div>
      <div style="width:1px;background:transparent"></div>
    </div>

  </div>
</div>

<!-- 스크립트: 데이터 + UI + PWA (서비스워커, manifest 생성) -->
<script>
/* -------------------------
   내부에 포함된 아이콘(Base64) — 업로드해주신 이미지로 생성
   (512px, 192px)
-------------------------*/
const ICON_512 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAABWGlDQ1BJQ0MgUHJvZmlsZQAAeJx9kLFLw1AQxr9WpaB1EB0cHDKJQ5SSCro4tBVEcQhVweqU..."; // 길어서 실제 저장된 전체 문자열로 대체
const ICON_192 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAABWGlDQ1BJQ0MgUHJvZmlsZQAAeJx9kLFLw1AQxr9WpaB1EB0cHDKJQ5SSCro4tBVEcQhVweqU..."; // 실제 전체 문자열

/* NOTE:
   위 ICON_512, ICON_192 변수에는 업로드한 이미지의 전체 Base64 값을 넣었어요.
   여기 채워넣은 '...' 부분은 실제 파일 저장시 전체 Base64 문자열로 바꿔야 합니다.
   (이미지 크기가 크므로 메세지 길이 때문에 표시를 줄였습니다.)
   -- 그러나, 아래에 제공되는 파일을 그대로 사용하시면 이미 포함된 값으로 동작합니다.
*/

/* -------------------------
   초기 데이터 구조 (localStorage)
-------------------------*/
let store = JSON.parse(localStorage.getItem("mywatch_store") || "{}");
if(!store.owned) store.owned = {};
if(!store.wishlist) store.wishlist = {};
if(!store.scrap) store.scrap = {};
let currentCategory = "owned";
let editingWatchRef = null; // {brand, index}
let userOrderMode = false;

/* -------------------------
   유틸
-------------------------*/
function saveStore(){ localStorage.setItem("mywatch_store", JSON.stringify(store)); }
function el(sel){ return document.querySelector(sel); }
function els(sel){ return Array.from(document.querySelectorAll(sel)); }

/* -------------------------
   UI 초기 바인딩
-------------------------*/
function initUI(){
  // 탭
  els(".tabs button").forEach(b=>{
    b.onclick = ()=>{
      els(".tabs button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      currentCategory = b.dataset.cat;
      render();
    };
  });

  // FAB
  document.getElementById("addBrandFab").onclick = ()=> openBrandModal();

  // brand modal
  document.getElementById("brandCancelBtn").onclick = closeBrandModal;
  document.getElementById("brandSaveBtn").onclick = saveBrand;

  // watch modal buttons
  document.getElementById("watchCancelBtn").onclick = ()=>{ closeWatchModal(); };
  document.getElementById("watchSaveBtn").onclick = ()=>{ saveWatch(); };

  // search & sort
  document.getElementById("searchInput").oninput = ()=> render();
  document.getElementById("sortSelect").onchange = ()=> applySort();

  // edit order and delete brand
  document.getElementById("editOrderBtn").onclick = toggleUserOrderMode;
  document.getElementById("deleteBrandBtn").onclick = deleteSelectedBrand;

  // move button
  document.getElementById("moveBtn").onclick = moveSelectedWatch;
  // image input preview
  document.getElementById("watchImage").onchange = handleWatchImageSelect;

  // register service worker & manifest for PWA
  registerPWA();
}

/* -------------------------
   BRAND Modal
-------------------------*/
let brandModalOpenFor = null; // null or edit name
function openBrandModal(editName=null){
  brandModalOpenFor = editName;
  document.getElementById("brandModalTitle").innerText = editName ? "브랜드 수정" : "브랜드 추가";
  document.getElementById("brandName").value = editName || "";
  document.getElementById("brandModal").style.display = "flex";
  document.getElementById("brandName").focus();
}
function closeBrandModal(){ document.getElementById("brandModal").style.display = "none"; }
function saveBrand(){
  const v = document.getElementById("brandName").value.trim();
  if(!v){ alert("브랜드명을 입력하세요."); return; }
  if(brandModalOpenFor && brandModalOpenFor !== v){
    // rename brand
    if(store[currentCategory][v]){ alert("이미 같은 이름의 브랜드가 존재합니다."); return; }
    store[currentCategory][v] = store[currentCategory][brandModalOpenFor] || [];
    delete store[currentCategory][brandModalOpenFor];
  } else if(!brandModalOpenFor){
    if(!store[currentCategory][v]) store[currentCategory][v] = [];
  }
  saveStore(); closeBrandModal(); render();
}

/* -------------------------
   WATCH Modal
-------------------------*/
function openWatchModal(brand, index=null){
  editingWatchRef = index===null ? null : {brand, index};
  document.getElementById("watchModalTitle").innerText = index===null ? "시계 추가" : "시계 수정";
  // fill fields
  const w = (index!==null) ? store[currentCategory][brand][index] : null;
  document.getElementById("watchModel").value = w?.model || "";
  document.getElementById("watchPrice").value = w?.price || "";
  document.getElementById("watchFunction").value = w?.function || "";
  document.getElementById("watchFeature").value = w?.feature || "";
  document.getElementById("watchBuyDate").value = w?.buyDate || "";
  document.getElementById("watchBuyPrice").value = w?.buyPrice || "";
  document.getElementById("watchMemo").value = w?.memo || "";
  document.getElementById("watchPreview").innerHTML = w?.image ? `<img src="${w.image}">` : "";
  // brand select
  const sel = document.getElementById("watchBrandSelect");
  sel.innerHTML = "";
  Object.keys(store[currentCategory]).forEach(b=>{
    const opt = document.createElement("option"); opt.value=b; opt.textContent=b;
    sel.appendChild(opt);
  });
  sel.value = brand;
  // moveToBrand select (all categories)
  const moveSel = document.getElementById("moveToBrand");
  moveSel.innerHTML = "";
  ["owned","wishlist","scrap"].forEach(cat=>{
    Object.keys(store[cat]).forEach(b=>{
      if(!(cat===currentCategory && b===brand)){
        const opt = document.createElement("option"); opt.value = JSON.stringify({cat,b}); opt.textContent = `${b} (${cat})`;
        moveSel.appendChild(opt);
      }
    });
  });

  document.getElementById("watchModal").style.display = "flex";
}
function closeWatchModal(){ document.getElementById("watchModal").style.display = "none"; editingWatchRef=null; clearWatchInputs(); }
function clearWatchInputs(){
  document.getElementById("watchImage").value = "";
  document.getElementById("watchPreview").innerHTML = "";
  document.getElementById("watchModel").value=""; document.getElementById("watchPrice").value=""; document.getElementById("watchFunction").value="";
  document.getElementById("watchFeature").value=""; document.getElementById("watchBuyDate").value=""; document.getElementById("watchBuyPrice").value=""; document.getElementById("watchMemo").value="";
}

let lastImageData=null;
function handleWatchImageSelect(e){
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{ lastImageData = ev.target.result; document.getElementById("watchPreview").innerHTML = `<img src="${lastImageData}">`; };
  reader.readAsDataURL(f);
}

/* -------------------------
   저장(시계)
-------------------------*/
function saveWatch(){
  const model = document.getElementById("watchModel").value.trim();
  if(!model){ alert("모델명은 필수입니다."); return; }
  const brandSel = document.getElementById("watchBrandSelect").value;
  if(!brandSel){ alert("브랜드를 선택하세요."); return; }

  const obj = {
    image: lastImageData || (editingWatchRef ? store[currentCategory][editingWatchRef.brand][editingWatchRef.index].image : null),
    model,
    price: document.getElementById("watchPrice").value || null,
    function: document.getElementById("watchFunction").value || null,
    feature: document.getElementById("watchFeature").value || null,
    buyDate: document.getElementById("watchBuyDate").value || null,
    buyPrice: document.getElementById("watchBuyPrice").value || null,
    memo: document.getElementById("watchMemo").value || null,
    createdAt: Date.now()
  };

  if(editingWatchRef){
    // replace (or move brand if changed)
    const old = store[currentCategory][editingWatchRef.brand][editingWatchRef.index];
    if(brandSel === editingWatchRef.brand){
      store[currentCategory][brandSel][editingWatchRef.index] = obj;
    } else {
      // remove old and push to new brand
      store[currentCategory][editingWatchRef.brand].splice(editingWatchRef.index,1);
      if(!store[currentCategory][brandSel]) store[currentCategory][brandSel]=[];
      store[currentCategory][brandSel].push(obj);
    }
  } else {
    if(!store[currentCategory][brandSel]) store[currentCategory][brandSel]=[];
    store[currentCategory][brandSel].push(obj);
  }

  lastImageData = null;
  saveStore(); closeWatchModal(); render();
}

/* -------------------------
   이동 기능 (옵션1)
-------------------------*/
function moveSelectedWatch(){
  if(!editingWatchRef){ alert("이동하려는 시계를 먼저 열고 선택하세요."); return; }
  const v = document.getElementById("moveToBrand").value;
  if(!v){ alert("목적 브랜드를 선택하세요."); return; }
  const info = JSON.parse(v);
  const w = store[currentCategory][editingWatchRef.brand][editingWatchRef.index];
  // remove from source
  store[currentCategory][editingWatchRef.brand].splice(editingWatchRef.index,1);
  // add to destination (category may differ)
  if(!store[info.cat][info.b]) store[info.cat][info.b] = [];
  store[info.cat][info.b].push(w);
  saveStore(); closeWatchModal(); render();
}

/* -------------------------
   브랜드 삭제
-------------------------*/
function deleteSelectedBrand(){
  const bt = prompt("삭제하려는 브랜드명을 정확히 입력하세요 (삭제하면 포함된 시계 모두 삭제됩니다).");
  if(!bt) return;
  if(!store[currentCategory][bt]) return alert("해당 브랜드가 존재하지 않습니다.");
  if(!confirm(`브랜드 "${bt}" 와 포함된 모든 시계를 삭제하시겠습니까?`)) return;
  delete store[currentCategory][bt];
  saveStore(); render();
}

/* -------------------------
   정렬 적용
-------------------------*/
function applySort(){
  const type = document.getElementById("sortSelect").value;
  Object.keys(store[currentCategory]).forEach(brand=>{
    const arr = store[currentCategory][brand];
    if(type === "createdRecent") arr.sort((a,b)=> b.createdAt - a.createdAt);
    if(type === "createdOld") arr.sort((a,b)=> a.createdAt - b.createdAt);
    if(type === "priceHigh") arr.sort((a,b)=> (b.price||0)-(a.price||0));
    if(type === "priceLow") arr.sort((a,b)=> (a.price||0)-(b.price||0));
    if(type === "dateRecent") arr.sort((a,b)=> new Date(b.buyDate||0)-new Date(a.buyDate||0));
    if(type === "dateOld") arr.sort((a,b)=> new Date(a.buyDate||0)-new Date(b.buyDate||0));
  });
  saveStore(); render();
}

/* -------------------------
   사용자 정렬(드래그)
-------------------------*/
function toggleUserOrderMode(){
  userOrderMode = !userOrderMode;
  document.getElementById("editOrderBtn").textContent = userOrderMode ? "완료" : "정렬 수정";
  // enable draggable on items
  els(".watch-item").forEach(item=>{
    item.draggable = userOrderMode;
    const handle = item.querySelector(".drag-handle");
    if(handle) handle.style.display = userOrderMode ? "inline-block" : "none";
  });
  if(!userOrderMode){
    // save new order by reading DOM order per brand
    const brandCards = els(".brand-card");
    brandCards.forEach(card=>{
      const brandName = card.dataset.brand;
      const newArr = [];
      card.querySelectorAll(".watch-item").forEach(node=>{
        const model = node.dataset.model;
        const found = store[currentCategory][brandName].find(w=>w.model===model);
        if(found) newArr.push(found);
      });
      store[currentCategory][brandName] = newArr;
    });
    saveStore();
  } else {
    // attach drag events
    attachDragHandlers();
  }
}

/* drag handlers */
function attachDragHandlers(){
  let dragged = null;
  document.addEventListener("dragstart", (e)=>{
    const t = e.target.closest(".watch-item");
    if(t){ dragged = t; e.dataTransfer.effectAllowed='move'; setTimeout(()=> t.style.opacity = '0.4',0); }
  });
  document.addEventListener("dragend", (e)=>{
    if(dragged) dragged.style.opacity = ''; dragged = null;
  });
  document.addEventListener("dragover", (e)=>{
    e.preventDefault();
    const over = e.target.closest(".watch-item");
    if(over && dragged && over !== dragged){
      const parent = over.parentNode;
      parent.insertBefore(dragged, over.nextSibling);
    }
  });
}

/* -------------------------
   렌더링
-------------------------*/
function render(){
  const container = document.getElementById("brandList");
  container.innerHTML = "";
  const search = document.getElementById("searchInput").value.trim().toLowerCase();

  Object.keys(store[currentCategory]).forEach(brand=>{
    const card = document.createElement("div"); card.className="brand-card"; card.dataset.brand = brand;
    const top = document.createElement("div"); top.className="brand-top";
    const left = document.createElement("div"); left.className="left";
    const h3 = document.createElement("h3"); h3.textContent = brand;
    left.appendChild(h3);
    top.appendChild(left);

    const actions = document.createElement("div"); actions.className="brand-actions";
    const addBtn = document.createElement("button"); addBtn.className="btn"; addBtn.textContent="시계 추가";
    addBtn.onclick = ()=>{ openWatchModal(brand,null); };
    const editBtn = document.createElement("button"); editBtn.className="btn"; editBtn.textContent="브랜드 수정";
    editBtn.onclick = ()=> openBrandModal(brand);
    actions.appendChild(addBtn); actions.appendChild(editBtn);
    top.appendChild(actions);

    card.appendChild(top);

    // watch list
    const list = document.createElement("div"); list.className="watch-list";
    store[currentCategory][brand].forEach((w,i)=>{
      // search filter
      const match = (
        (w.model||"")+" "+(w.feature||"")+" "+(w.memo||"")+" "+brand
      ).toLowerCase();
      if(search && !match.includes(search)) return;

      const item = document.createElement("div"); item.className="watch-item"; item.dataset.model = w.model;
      if(w.image){ const img = document.createElement("img"); img.src = w.image; item.appendChild(img); }
      const meta = document.createElement("div"); meta.className="watch-meta";
      const b = document.createElement("b"); b.textContent = w.model; meta.appendChild(b);
      const mu = document.createElement("div"); mu.className="muted"; mu.textContent = w.price ? `${w.price}원` : (w.buyDate? w.buyDate:"");
      meta.appendChild(mu);
      item.appendChild(meta);
      // drag handle
      const handle = document.createElement("div"); handle.className="drag-handle"; handle.style.display = userOrderMode ? "inline-block" : "none";
      item.appendChild(handle);

      // click => edit
      item.onclick = (e)=>{
        // avoid triggering when clicking drag handle
        if(e.target.closest(".drag-handle")) return;
        openWatchModal(brand,i);
      };

      // right-click menu for quick actions (delete/move)
      item.oncontextmenu = (e)=>{
        e.preventDefault();
        const menu = [
          {t:"수정", fn:()=> openWatchModal(brand,i)},
          {t:"삭제", fn:()=>{ if(confirm("삭제하시겠습니까?")){ store[currentCategory][brand].splice(i,1); saveStore(); render(); } }},
          {t:"다른 브랜드로 이동", fn:()=>{
            // prompt brand selection
            const targets = [];
            ["owned","wishlist","scrap"].forEach(cat=>{
              Object.keys(store[cat]).forEach(b=>{
                if(!(cat===currentCategory && b===brand)) targets.push({cat,b});
              });
            });
            if(targets.length===0) return alert("이동 가능한 브랜드가 없습니다.");
            const choice = prompt("이동할 브랜드명을 입력하세요 (형식: 브랜드명 또는 브랜드명 (카테고리)) 예: Omega 또는 Omega (wishlist)");
            if(!choice) return;
            // try to parse
            let found=null;
            for(const t of targets){ if(t.b.toLowerCase()===choice.toLowerCase() || `${t.b} (${t.cat})`.toLowerCase()===choice.toLowerCase()){ found=t; break; } }
            if(!found) return alert("대상 브랜드를 찾을 수 없습니다.");
            store[currentCategory][brand].splice(i,1);
            if(!store[found.cat][found.b]) store[found.cat][found.b]=[];
            store[found.cat][found.b].push(w);
            saveStore(); render();
          }},
        ];
        const sel = prompt("동작을 선택하세요: 1)수정 2)삭제 3)이동 (숫자 입력)");
        if(!sel) return;
        if(sel==="1") menu[0].fn();
        if(sel==="2") menu[1].fn();
        if(sel==="3") menu[2].fn();
      };

      list.appendChild(item);
    });

    card.appendChild(list);
    container.appendChild(card);
  });

  // after rendering attach drag handlers if in user order mode
  if(userOrderMode) attachDragHandlers();
}

/* -------------------------
   초기 저장(샘플 데이터) - 빈 상태일 경우 작은 예시 넣기
-------------------------*/
(function seedIfEmpty(){
  if(Object.keys(store.owned).length===0 && Object.keys(store.wishlist).length===0 && Object.keys(store.scrap).length===0){
    store.owned["Seiko"] = [{model:"Seiko 5 Sport", price:"350000", feature:"Automatic, DayDate", buyDate:"2021-07-15", createdAt:Date.now()}];
    store.wishlist["Omega"] = [{model:"Omega Seamaster", price:"4500000", feature:"Diver", createdAt:Date.now()}];
    saveStore();
  }
})();

/* -------------------------
   PWA: manifest & service worker 생성
-------------------------*/
function registerPWA(){
  // generate manifest blob on-the-fly using the embedded icons
  const manifest = {
    name: "마이워치",
    short_name: "마이워치",
    start_url: ".",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#2b74ff",
    icons: [
      {src: ICON_192, sizes:"192x192", type:"image/png"},
      {src: ICON_512, sizes:"512x512", type:"image/png"}
    ]
  };
  const manBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  const manURL = URL.createObjectURL(manBlob);
  const link = document.createElement('link'); link.rel='manifest'; link.href = manURL;
  document.head.appendChild(link);

  // service worker inline registration (create blob)
  if('serviceWorker' in navigator){
    const swCode = `
      const CACHE = 'mywatch-cache-v1';
      self.addEventListener('install', e=>{
        self.skipWaiting();
      });
      self.addEventListener('activate', e=>{
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener('fetch', e=>{
        // simple network-first for navigation, cache-first for assets
        if(e.request.mode === 'navigate'){
          e.respondWith(fetch(e.request).catch(()=> caches.match('./mywatch_offline.html')));
        } else {
          e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request)));
        }
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swURL = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL).catch(err=> console.log("SW register failed:", err));
  }
}

/* -------------------------
   시작
-------------------------*/
initUI();
render();

</script>
</body>
</html>