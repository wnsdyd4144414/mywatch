<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>마이워치</title>

<!-- manifest -->
<link rel="manifest" id="manifest-placeholder">

<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{
    --bg:#101014;
    --soft:#1a1a1f;
    --glass:rgba(255,255,255,0.05);
    --border:rgba(255,255,255,0.12);
    --inner:inset 0 0 4px rgba(255,255,255,0.12);
    --outer:0 3px 8px rgba(0,0,0,0.45);
    --radius:4px;
    --text:#fff;
    --sub:#b6b6b6;
    --accent:#3b7bff;
  }

  html,body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro", Inter, Roboto, sans-serif;
  }

  .app{
    max-width:1000px;
    margin:0 auto;
    padding:18px;
  }

  /* 헤더 */
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
  h1{margin:0;font-size:20px;font-weight:600;}
  .small{color:var(--sub);font-size:13px;}

  /* -------- 스퀘어 모피즘 공통 UI -------- */
  .sq{
    background:var(--glass);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--inner), var(--outer);
    backdrop-filter:blur(16px);
  }

  input[type="text"], input[type="file"]{
    width:100%;
    padding:8px;
    border-radius:var(--radius);
    background:var(--glass);
    border:1px solid var(--border);
    color:var(--text);
    box-shadow:var(--inner);
  }

  /* 버튼 */
  .btn{
    padding:8px 10px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:var(--glass);
    color:var(--text);
    cursor:pointer;
    box-shadow:var(--inner), var(--outer);
  }

  .btn:hover{background:rgba(255,255,255,0.08);}
  .btn:active{transform:scale(.97);}

  /* ghost button */
  .ghost{
    background:transparent !important;
  }

  /* 카테고리 카드 */
  .cat{
    flex:1 1 150px;
    min-width:150px;
    padding:18px;
    text-align:center;
    cursor:pointer;
  }
  .cat h2{margin:0 0 8px 0}
  .cat p{margin:0;font-size:13px;color:var(--sub)}

  /* 그리드 */
  .categories{
    display:flex;
    gap:14px;
    flex-wrap:wrap;
    margin-top:18px;
  }

  /* 브랜드 카드 */
  .brand-card{
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .brand-image{
    width:100%;
    height:120px;
    border-radius:var(--radius);
    object-fit:cover;
    background:#0003;
  }

  .brand-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .brand-name{font-weight:600;}

  .brand-list{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
    gap:12px;
    margin-top:14px;
  }

  /* 시계 리스트 */
  .watch-list{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
    gap:12px;
    margin-top:14px;
  }

  .watch-item{
    padding:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }

  .watch-img{
    width:100%;
    height:130px;
    border-radius:var(--radius);
    object-fit:cover;
    background:#0003;
  }

  /* 모달 */
  #modal{
    position:fixed;
    left:0; top:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.4);
    backdrop-filter:blur(6px);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }

  #modal-card{
    padding:16px;
    max-width:420px;
    width:100%;
  }

  /* 페이지 숨김 처리 */
  main section{display:none;}
  main section.active{display:block;}
</style>
</head>
<body>
<div class="app">

<header>
  <div>
    <h1>마이워치</h1>
    <div class="small">스퀘어 모피즘 버전</div>
  </div>
  <div id="nav-actions"></div>
</header>

<main>
  <!-- 1) 메인 -->
  <section id="page-main" class="active">
    <div class="small">카테고리를 선택하세요</div>
    <div class="categories" id="categories-root"></div>
  </section>

  <!-- 2) 카테고리 내부 -->
  <section id="page-category">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
      <button class="btn ghost" onclick="showMain()">←</button>
      <strong id="category-title"></strong>
    </div>

    <div style="display:flex;gap:8px;">
      <input type="text" id="brand-search" placeholder="브랜드 검색">
      <button class="btn" onclick="openAddBrand()">브랜드 추가</button>
    </div>

    <div class="brand-list" id="brand-list"></div>
  </section>

  <!-- 3) 브랜드 내부 -->
  <section id="page-brand">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
      <button class="btn ghost" onclick="showCategory(currentCategoryIndex)">←</button>
      <strong id="brand-title"></strong>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input type="text" id="watch-name" placeholder="시계 이름">
      <input type="file" id="watch-img" accept="image/*">
      <button class="btn" onclick="addWatch()">시계 추가</button>
    </div>

    <div class="watch-list" id="watch-list"></div>
  </section>
</main>

<!-- 모달 -->
<div id="modal">
  <div id="modal-card" class="sq"></div>
</div>

</div>
<script>
/* ===== 데이터 구조 ===== */
let categories = JSON.parse(localStorage.getItem("MW_data") || "null");
if (!categories) {
  categories = [
    { name:"보유", brands:[] },
    { name:"미보유", brands:[] },
    { name:"추억", brands:[] }
  ];
}

let currentCategoryIndex = null;
let currentBrandIndex = null;

function save(){ localStorage.setItem("MW_data", JSON.stringify(categories)); }

/* ===== 페이지 전환 ===== */
function showPage(id){
  document.querySelectorAll("main section").forEach(sec => sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ===== 메인 ===== */
function renderMain(){
  const root = document.getElementById("categories-root");
  root.innerHTML = "";
  categories.forEach((cat, i)=>{
    const el = document.createElement("div");
    el.className = "sq cat";
    el.innerHTML = `<h2>${cat.name}</h2><p>${cat.brands.length}개 브랜드</p>`;
    el.onclick = () => showCategory(i);
    root.appendChild(el);
  });
}
renderMain();

function showMain(){
  currentCategoryIndex = null;
  showPage("page-main");
}

/* ===== 카테고리 내부 ===== */
function showCategory(i){
  currentCategoryIndex = i;
  document.getElementById("category-title").textContent = categories[i].name;
  document.getElementById("brand-search").value = "";
  renderBrandList();
  showPage("page-category");
}

function renderBrandList(){
  const wrap = document.getElementById("brand-list");
  wrap.innerHTML = "";

  const q = document.getElementById("brand-search").value.toLowerCase();
  categories[currentCategoryIndex].brands.forEach((brand, bi)=>{
    if (q && !brand.name.toLowerCase().includes(q)) return;

    const card = document.createElement("div");
    card.className = "sq brand-card";

    card.innerHTML = `
      <img src="${brand.img}" class="brand-image">
      <div class="brand-row">
        <div>
          <div class="brand-name">${brand.name}</div>
          <div class="small">${brand.watches.length}개 시계</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button class="btn" onclick="showBrand(${bi})">열기</button>
          <button class="btn ghost" onclick="deleteBrand(${bi})">삭제</button>
        </div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn ghost" onclick="moveBrandUp(${bi})">↑</button>
        <button class="btn ghost" onclick="moveBrandDown(${bi})">↓</button>
      </div>
    `;
    wrap.appendChild(card);
  });
}

function deleteBrand(i){
  if(confirm("삭제할까요?")){
    categories[currentCategoryIndex].brands.splice(i,1);
    save();
    renderBrandList();
  }
}

function moveBrandUp(i){
  if(i===0) return;
  let arr = categories[currentCategoryIndex].brands;
  [arr[i], arr[i-1]] = [arr[i-1], arr[i]];
  save(); renderBrandList();
}

function moveBrandDown(i){
  let arr = categories[currentCategoryIndex].brands;
  if(i === arr.length-1) return;
  [arr[i], arr[i+1]] = [arr[i+1], arr[i]];
  save(); renderBrandList();
}

/* ===== 브랜드 추가 (모달) ===== */
function openAddBrand(){
  const modal = document.getElementById("modal");
  const card = document.getElementById("modal-card");

  card.innerHTML = `
    <h3 style="margin-top:0;">브랜드 추가</h3>
    <input id="b-name" type="text" placeholder="브랜드명">
    <div style="margin-top:8px;">
      <input id="b-img" type="file" accept="image/*">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn" onclick="addBrand()">추가</button>
      <button class="btn ghost" onclick="closeModal()">취소</button>
    </div>
  `;
  modal.style.display = "flex";
}

function addBrand(){
  const name = document.getElementById("b-name").value.trim();
  const file = document.getElementById("b-img").files[0];
  if(!name){ alert("브랜드명을 입력하세요"); return; }

  if(file){
    const fr = new FileReader();
    fr.onload = e => {
      pushBrand(name, e.target.result);
      closeModal();
    };
    fr.readAsDataURL(file);
  } else {
    pushBrand(name, "");
    closeModal();
  }
}

function pushBrand(name, img){
  categories[currentCategoryIndex].brands.push({
    name, img, watches:[]
  });
  save(); renderBrandList();
}

function closeModal(){ document.getElementById("modal").style.display = "none"; }

/* ===== 브랜드 내부 (시계) ===== */
function showBrand(bi){
  currentBrandIndex = bi;
  document.getElementById("brand-title").textContent =
    categories[currentCategoryIndex].brands[bi].name;

  renderWatchList();
  showPage("page-brand");
}

function renderWatchList(){
  const wrap = document.getElementById("watch-list");
  const brand = categories[currentCategoryIndex].brands[currentBrandIndex];

  wrap.innerHTML = "";
  brand.watches.forEach((w, wi)=>{
    const item = document.createElement("div");
    item.className = "sq watch-item";
    item.innerHTML = `
      <img src="${w.img}" class="watch-img">
      <div style="font-weight:600;">${w.name}</div>
      <div style="display:flex;gap:8px;width:100%;">
        <button class="btn" onclick="editWatch(${wi})">수정</button>
        <button class="btn ghost" onclick="deleteWatch(${wi})">삭제</button>
      </div>
    `;
    wrap.appendChild(item);
  });
}

/* 시계 추가 */
function addWatch(){
  const name = document.getElementById("watch-name").value.trim();
  const file = document.getElementById("watch-img").files[0];
  if(!name){ alert("이름 입력"); return; }
  if(!file){ alert("이미지를 선택하세요"); return; }

  const fr = new FileReader();
  fr.onload = e => {
    categories[currentCategoryIndex].brands[currentBrandIndex].watches.push({
      name,
      img:e.target.result
    });
    save();
    document.getElementById("watch-name").value="";
    document.getElementById("watch-img").value=null;
    renderWatchList();
  };
  fr.readAsDataURL(file);
}

function deleteWatch(i){
  if(confirm("삭제?")){
    categories[currentCategoryIndex].brands[currentBrandIndex].watches.splice(i,1);
    save(); renderWatchList();
  }
}

/* ===== PWA (Blob manifest/SW) ===== */
const manifest = {
  name:"마이워치",
  short_name:"마이워치",
  start_url:"./",
  display:"standalone",
  theme_color:"#000000",
  background_color:"#000000",
  icons:[
    {src:"icon-192.png",sizes:"192x192",type:"image/png"},
    {src:"icon-512.png",sizes:"512x512",type:"image/png"}
  ]
};

const mBlob = new Blob([JSON.stringify(manifest)],{type:"application/json"});
document.getElementById("manifest-placeholder").href = URL.createObjectURL(mBlob);

const swBlob = new Blob([`
self.addEventListener("install",e=>self.skipWaiting());
self.addEventListener("activate",e=>self.clients.claim());
self.addEventListener("fetch",e=>e.respondWith(fetch(e.request).catch(()=>{})));
`],{type:"text/javascript"});
if("serviceWorker" in navigator){
  navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}
</script>

</body>
</html>